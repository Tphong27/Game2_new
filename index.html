<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ĐƯỜNG ĐUA NƯỚC - Flow Race</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>
          <span class="water-emoji">🌊</span> ĐƯỜNG ĐUA <span>NƯỚC</span>
          <span class="water-emoji">💧</span>
        </h1>
        <p>
          Flow Race - Phần I: Cội nguồn Triết học – Vũ trụ quan & Hình thái Ý
          thức
        </p>
      </header>

      <!-- Setup Screen -->
      <div id="setupScreen" class="setup-screen">
        <h2>🎮 Chào mừng đến với ĐƯỜNG ĐUA NƯỚC!</h2>
        <p style="margin: 20px 0; line-height: 1.8">
          Ba đội A, B, C sẽ thi đua đưa "dòng nước" về đích.<br />
          Trả lời đúng để tiến lên, sai sẽ mất lượt!<br />
          Tại ngã rẽ (FORK): đúng = chọn đường, sai = đi đường vòng!
        </p>
        <button class="btn btn-primary" onclick="startGame()">
          🚀 BẮT ĐẦU CHƠI
        </button>

        <div class="rules-panel" style="margin-top: 30px; text-align: left">
          <h3>📋 Luật chơi</h3>
          <ul>
            <li>
              <strong>Chia đội:</strong> 3 nhóm lớn (A, B, C), mỗi nhóm có 3
              nhóm nhỏ (1-2-3, 4-5-6, 7-9-10)
            </li>
            <li>
              <strong>Lượt chơi:</strong> Các nhóm nhỏ luân phiên trong nhóm lớn
              (1→2→3→1...)
            </li>
            <li>
              <strong>Trả lời đúng:</strong> Tiến 1 checkpoint (+10 điểm cho
              nhóm nhỏ)
            </li>
            <li><strong>Trả lời sai:</strong> Đứng lại, mất lượt</li>
            <li>
              <strong>FORK:</strong> Đúng = chọn nhánh; Sai = bị đẩy sang nhánh
              vòng
            </li>
            <li><strong>Về đích:</strong> Nhất +50, Nhì +30, Ba +20</li>
            <li>
              <strong>⏱️ Thời gian:</strong> Dễ = 7s, Khó = 10s, Rất khó = 15s.
              Hết giờ vẫn được chọn đáp án!
            </li>
          </ul>
        </div>
      </div>

      <!-- Game Board -->
      <div id="gameBoard" class="game-board">
        <div class="game-layout">
          <!-- Left: Controls -->
          <div class="game-controls">
            <div class="current-turn">
              <h3>🎯 LƯỢT HIỆN TẠI</h3>
              <div id="currentTeam" class="team-name">1</div>
              <button
                class="btn btn-primary"
                onclick="showQuestion()"
                style="margin-top: 10px"
              >
                📝 BẮT ĐẦU CÂU HỎI
              </button>
            </div>
            <div class="scoreboard" style="margin-top: 15px">
              <h3>🏆 BẢNG ĐIỂM</h3>
              <div class="score-grid" id="scoreGrid">
                <!-- Generated by JS -->
              </div>
            </div>
          </div>

          <!-- Right: Race Tracks (always visible) -->
          <div class="tracks-wrapper">
            <div class="tracks-container" id="tracksContainer">
              <!-- Generated by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- Winner Screen -->
      <div id="winnerScreen" class="winner-screen">
        <h2>🎊 KẾT THÚC! 🎊</h2>
        <div class="final-scores" id="finalScores">
          <!-- Generated by JS -->
        </div>
        <button class="btn btn-primary" onclick="resetGame()">
          🔄 CHƠI LẠI
        </button>
      </div>
    </div>

    <!-- Question Modal -->
    <div id="questionModal" class="modal">
      <div class="modal-content">
        <h2 id="modalTitle">
          ❓ Câu hỏi cho nhóm <span id="questionTeam"></span>
        </h2>
        <span id="difficultyBadge" class="difficulty-badge"></span>
        <div class="timer" id="timerDisplay">
          ⏱️ <span id="timeLeft">7</span>s
        </div>
        <div id="questionContent">
          <!-- Question content goes here -->
        </div>
      </div>
    </div>

    <!-- Fork Choice Modal -->
    <div id="forkModal" class="modal">
      <div class="modal-content fork-choice">
        <h2>🔀 CHỌN ĐƯỜNG ĐI!</h2>
        <p style="margin: 20px 0">
          Chúc mừng! Bạn trả lời đúng và được quyền chọn nhánh:
        </p>
        <button class="btn btn-secondary" onclick="chooseFork('fast')">
          ⚡ Nhánh NHANH<br />
          <small>(Ít checkpoint, câu hỏi khó)</small>
        </button>
        <button class="btn btn-primary" onclick="chooseFork('slow')">
          🌿 Nhánh VÒNG<br />
          <small>(Nhiều checkpoint, câu hỏi dễ)</small>
        </button>
      </div>
    </div>

    <!-- Team Selection Modal 1 - First Group -->
    <div id="teamSelectModal" class="modal team-select-modal">
      <div class="modal-content">
        <h2>🎯 CHỌN NHÓM XUẤT PHÁT</h2>
        <p style="margin: 10px 0; color: #aaa">
          Nhập số nhóm được đi <strong style="color: #f1c40f">ĐẦU TIÊN</strong>:
        </p>

        <div class="team-legend">
          <div class="legend-item">
            <div class="legend-color team-a"></div>
            A: 1, 2, 3
          </div>
          <div class="legend-item">
            <div class="legend-color team-b"></div>
            B: 4, 5, 6
          </div>
          <div class="legend-item">
            <div class="legend-color team-c"></div>
            C: 7, 8, 10
          </div>
        </div>

        <div class="group-input-container">
          <input
            type="text"
            id="groupInput"
            class="group-input"
            placeholder="?"
            maxlength="2"
            onkeypress="handleGroupInputKey(event, 1)"
          />
          <p class="input-hint">Nhập: 1, 2, 3, 4, 5, 6, 7, 8 hoặc 10</p>
        </div>

        <div class="select-result" id="selectResult"></div>

        <button class="btn btn-primary" onclick="confirmGroupSelection(1)">
          ✅ XÁC NHẬN
        </button>
      </div>
    </div>

    <!-- Team Selection Modal 2 - Second Group -->
    <div id="teamSelectModal2" class="modal team-select-modal">
      <div class="modal-content">
        <h2>🎯 CHỌN NHÓM THỨ HAI</h2>
        <p style="margin: 10px 0; color: #aaa">
          Nhập số nhóm được đi <strong style="color: #f1c40f">THỨ HAI</strong>:
        </p>

        <div class="selection-progress">
          <span class="progress-done"
            >✓ Nhóm 1: <strong id="firstGroupDisplay">?</strong></span
          >
          <span class="progress-arrow">→</span>
          <span class="progress-current">Nhóm 2: <strong>?</strong></span>
          <span class="progress-arrow">→</span>
          <span class="progress-pending">Nhóm 3: ?</span>
        </div>

        <div class="group-input-container">
          <input
            type="text"
            id="groupInput2"
            class="group-input"
            placeholder="?"
            maxlength="2"
            onkeypress="handleGroupInputKey(event, 2)"
          />
          <p class="input-hint" id="inputHint2">
            Nhập: 1, 2, 3, 4, 5, 6, 7, 8 hoặc 10
          </p>
        </div>

        <div class="select-result" id="selectResult2"></div>

        <button class="btn btn-primary" onclick="confirmGroupSelection(2)">
          ✅ XÁC NHẬN
        </button>
      </div>
    </div>

    <!-- Team Selection Modal 3 - Third Group -->
    <div id="teamSelectModal3" class="modal team-select-modal">
      <div class="modal-content">
        <h2>🎯 CHỌN NHÓM CUỐI CÙNG</h2>
        <p style="margin: 10px 0; color: #aaa">
          Nhập số nhóm được đi <strong style="color: #f1c40f">THỨ BA</strong>:
        </p>

        <div class="selection-progress">
          <span class="progress-done"
            >✓ Đội <strong id="firstTeamDisplay">?</strong></span
          >
          <span class="progress-arrow">→</span>
          <span class="progress-done"
            >✓ Đội <strong id="secondTeamDisplay">?</strong></span
          >
          <span class="progress-arrow">→</span>
          <span class="progress-current"
            >Đội <strong id="thirdTeamDisplay">?</strong></span
          >
        </div>

        <div class="group-input-container">
          <input
            type="text"
            id="groupInput3"
            class="group-input"
            placeholder="?"
            maxlength="2"
            onkeypress="handleGroupInputKey(event, 3)"
          />
          <p class="input-hint" id="inputHint3">Nhập: ?</p>
        </div>

        <div class="select-result" id="selectResult3"></div>

        <button class="btn btn-primary" onclick="confirmGroupSelection(3)">
          ✅ XÁC NHẬN & BẮT ĐẦU
        </button>
      </div>
    </div>

    <!-- Winner Celebration Modal -->
    <div id="winnerCelebrationModal" class="modal winner-celebration-modal">
      <div class="modal-content">
        <div class="celebration-container">
          <div class="winner-trophy">🏆</div>
          <div class="winner-message">🎉 CHÚC MỪNG! 🎉</div>
          <div class="winner-team-name" id="winnerTeamName">ĐỘI A</div>
          <p style="font-size: 1.3em; margin: 15px 0">ĐÃ VỀ ĐÍCH ĐẦU TIÊN!</p>
          <div class="winner-stats" id="winnerStats">
            <!-- Generated by JS -->
          </div>
          <button
            class="btn btn-primary"
            onclick="showFinalResults()"
            style="margin-top: 20px"
          >
            📊 XEM KẾT QUẢ TỔNG
          </button>
        </div>
      </div>
    </div>

    <!-- Load questions from external file -->
    <script src="questions.js"></script>

    <script>
      // ==================== GAME STATE ====================
      let gameState = {
        started: false,
        finished: false,
        teams: {
          A: {
            position: 0,
            branch: null,
            subTeams: ["1", "2", "3"],
            currentSubTeam: 0,
            finishOrder: 0,
          },
          B: {
            position: 0,
            branch: null,
            subTeams: ["4", "5", "6"],
            currentSubTeam: 0,
            finishOrder: 0,
          },
          C: {
            position: 0,
            branch: null,
            subTeams: ["7", "8", "10"],
            currentSubTeam: 0,
            finishOrder: 0,
          },
        },
        scores: {
          1: 0,
          2: 0,
          3: 0,
          4: 0,
          5: 0,
          6: 0,
          7: 0,
          8: 0,
          10: 0,
        },
        currentTeamIndex: 0,
        teamOrder: ["A", "B", "C"],
        finishedTeams: [],
        currentQuestion: null,
        pendingForkChoice: null,
        usedQuestions: { easy: [], medium: [], hard: [] },
      };

      // Track structure:
      // 0=START, 1=CP1, 2=CP2, 3=FORK1,
      // Fast: 4=CP3(hard), 5=FORK2
      // Slow: 4a=CP3a(easy), 4b=CP3b(easy), 5=FORK2
      // 6=CP5, 7=FINISH
      const trackStructure = {
        mainPath: [
          { type: "start", label: "START" },
          { type: "checkpoint", label: "①", difficulty: "easy" },
          { type: "checkpoint", label: "②", difficulty: "easy" },
          { type: "fork", label: "FORK", id: 1 },
        ],
        fastBranch1: [{ type: "checkpoint", label: "③", difficulty: "hard" }],
        slowBranch1: [
          { type: "checkpoint", label: "③a", difficulty: "easy" },
          { type: "checkpoint", label: "③b", difficulty: "easy" },
        ],
        afterFork1: [{ type: "fork", label: "FORK", id: 2 }],
        fastBranch2: [{ type: "checkpoint", label: "④", difficulty: "hard" }],
        slowBranch2: [
          { type: "checkpoint", label: "④a", difficulty: "medium" },
          { type: "checkpoint", label: "④b", difficulty: "medium" },
        ],
        finalPath: [
          { type: "checkpoint", label: "⑤", difficulty: "hard" },
          { type: "finish", label: "FINISH" },
        ],
      };

      // ==================== GAME FUNCTIONS ====================

      // Store selections temporarily
      let selectionState = {
        firstGroup: null,
        firstTeam: null,
        secondGroup: null,
        secondTeam: null,
        thirdGroup: null,
        thirdTeam: null,
      };

      const teamMap = {
        1: "A",
        2: "A",
        3: "A",
        4: "B",
        5: "B",
        6: "B",
        7: "C",
        8: "C",
        10: "C",
      };

      const teamGroups = {
        A: ["1", "2", "3"],
        B: ["4", "5", "6"],
        C: ["7", "8", "10"],
      };

      const teamColors = { A: "#e74c3c", B: "#27ae60", C: "#3498db" };

      function startGame() {
        // Reset selection state
        selectionState = {
          firstGroup: null,
          firstTeam: null,
          secondGroup: null,
          secondTeam: null,
          thirdGroup: null,
          thirdTeam: null,
        };

        // Show first team selection modal
        document.getElementById("setupScreen").style.display = "none";
        document.getElementById("teamSelectModal").classList.add("active");

        // Reset the modal state
        document.getElementById("groupInput").value = "";
        document.getElementById("selectResult").textContent = "";
        document.getElementById("groupInput").focus();
      }

      function handleGroupInputKey(event, step) {
        if (event.key === "Enter") {
          confirmGroupSelection(step);
        }
      }

      function getValidGroupsForStep(step) {
        const allGroups = ["1", "2", "3", "4", "5", "6", "7", "8", "10"];

        if (step === 1) {
          return allGroups;
        } else if (step === 2) {
          // Exclude all groups from the first team
          const firstTeamGroups = teamGroups[selectionState.firstTeam];
          return allGroups.filter((g) => !firstTeamGroups.includes(g));
        } else if (step === 3) {
          // Only groups from the third (last) team
          return teamGroups[selectionState.thirdTeam];
        }
        return allGroups;
      }

      function confirmGroupSelection(step) {
        const validGroups = getValidGroupsForStep(step);

        if (step === 1) {
          // First group selection - determines first team
          const input = document.getElementById("groupInput").value.trim();

          if (!validGroups.includes(input)) {
            document.getElementById("selectResult").innerHTML =
              '<span style="color: #e74c3c">⚠️ Vui lòng nhập: 1, 2, 3, 4, 5, 6, 7, 8 hoặc 10</span>';
            document.getElementById("groupInput").focus();
            return;
          }

          selectionState.firstGroup = input;
          selectionState.firstTeam = teamMap[input];

          // Show result briefly
          document.getElementById("selectResult").innerHTML =
            `✅ <strong style="color: ${teamColors[selectionState.firstTeam]}">ĐỘI ${selectionState.firstTeam}</strong> (Nhóm ${input}) sẽ đi đầu tiên!`;

          // Move to second modal after delay
          setTimeout(() => {
            document
              .getElementById("teamSelectModal")
              .classList.remove("active");

            // Get remaining teams' groups for step 2
            const step2Groups = getValidGroupsForStep(2);

            // Setup second modal
            document.getElementById("firstGroupDisplay").textContent =
              `${selectionState.firstTeam} (nhóm ${selectionState.firstGroup})`;
            document.getElementById("groupInput2").value = "";
            document.getElementById("selectResult2").textContent = "";
            document.getElementById("inputHint2").textContent =
              `Nhập: ${step2Groups.join(", ")}`;

            document.getElementById("teamSelectModal2").classList.add("active");
            document.getElementById("groupInput2").focus();
          }, 1000);
        } else if (step === 2) {
          // Second group selection - determines second team
          const input = document.getElementById("groupInput2").value.trim();

          if (!validGroups.includes(input)) {
            document.getElementById("selectResult2").innerHTML =
              `<span style="color: #e74c3c">⚠️ Vui lòng nhập: ${validGroups.join(", ")}</span>`;
            document.getElementById("groupInput2").focus();
            return;
          }

          selectionState.secondGroup = input;
          selectionState.secondTeam = teamMap[input];

          // Find the third team
          const allTeams = ["A", "B", "C"];
          selectionState.thirdTeam = allTeams.find(
            (t) =>
              t !== selectionState.firstTeam && t !== selectionState.secondTeam,
          );

          // Show result briefly
          document.getElementById("selectResult2").innerHTML =
            `✅ <strong style="color: ${teamColors[selectionState.secondTeam]}">ĐỘI ${selectionState.secondTeam}</strong> (Nhóm ${input}) sẽ đi thứ hai!`;

          // Move to third modal after delay
          setTimeout(() => {
            document
              .getElementById("teamSelectModal2")
              .classList.remove("active");

            // Get third team's groups for step 3
            const step3Groups = getValidGroupsForStep(3);

            // Setup third modal
            document.getElementById("firstTeamDisplay").textContent =
              selectionState.firstTeam;
            document.getElementById("secondTeamDisplay").textContent =
              selectionState.secondTeam;
            document.getElementById("thirdTeamDisplay").textContent =
              selectionState.thirdTeam;
            document.getElementById("groupInput3").value = "";
            document.getElementById("selectResult3").textContent = "";
            document.getElementById("inputHint3").textContent =
              `Nhập: ${step3Groups.join(", ")}`;

            document.getElementById("teamSelectModal3").classList.add("active");
            document.getElementById("groupInput3").focus();
          }, 1000);
        } else if (step === 3) {
          // Third group selection - determines starting sub-team for third team
          const input = document.getElementById("groupInput3").value.trim();

          if (!validGroups.includes(input)) {
            document.getElementById("selectResult3").innerHTML =
              `<span style="color: #e74c3c">⚠️ Vui lòng nhập: ${validGroups.join(", ")}</span>`;
            document.getElementById("groupInput3").focus();
            return;
          }

          selectionState.thirdGroup = input;

          // Set team order
          gameState.teamOrder = [
            selectionState.firstTeam,
            selectionState.secondTeam,
            selectionState.thirdTeam,
          ];

          // Set starting sub-teams for all teams
          const firstSubTeamIndex = gameState.teams[
            selectionState.firstTeam
          ].subTeams.indexOf(selectionState.firstGroup);
          const secondSubTeamIndex = gameState.teams[
            selectionState.secondTeam
          ].subTeams.indexOf(selectionState.secondGroup);
          const thirdSubTeamIndex = gameState.teams[
            selectionState.thirdTeam
          ].subTeams.indexOf(selectionState.thirdGroup);

          gameState.teams[selectionState.firstTeam].currentSubTeam =
            firstSubTeamIndex;
          gameState.teams[selectionState.secondTeam].currentSubTeam =
            secondSubTeamIndex;
          gameState.teams[selectionState.thirdTeam].currentSubTeam =
            thirdSubTeamIndex;
          gameState.currentTeamIndex = 0;

          // Show final result
          document.getElementById("selectResult3").innerHTML =
            `🎊 <strong>THỨ TỰ CHƠI:</strong><br>
             <span style="color: ${teamColors[selectionState.firstTeam]}">1. Đội ${selectionState.firstTeam} (bắt đầu: nhóm ${selectionState.firstGroup})</span><br>
             <span style="color: ${teamColors[selectionState.secondTeam]}">2. Đội ${selectionState.secondTeam} (bắt đầu: nhóm ${selectionState.secondGroup})</span><br>
             <span style="color: ${teamColors[selectionState.thirdTeam]}">3. Đội ${selectionState.thirdTeam} (bắt đầu: nhóm ${selectionState.thirdGroup})</span>`;

          // Start game after delay
          setTimeout(() => {
            document
              .getElementById("teamSelectModal3")
              .classList.remove("active");
            gameState.started = true;
            document.getElementById("gameBoard").classList.add("active");
            renderTracks();
            renderScoreboard();
            updateCurrentTeam();
          }, 2500);
        }
      }

      function resetGame() {
        gameState = {
          started: false,
          finished: false,
          teams: {
            A: {
              position: 0,
              branch: null,
              subTeams: ["1", "2", "3"],
              currentSubTeam: 0,
              finishOrder: 0,
            },
            B: {
              position: 0,
              branch: null,
              subTeams: ["4", "5", "6"],
              currentSubTeam: 0,
              finishOrder: 0,
            },
            C: {
              position: 0,
              branch: null,
              subTeams: ["7", "8", "10"],
              currentSubTeam: 0,
              finishOrder: 0,
            },
          },
          scores: {
            1: 0,
            2: 0,
            3: 0,
            4: 0,
            5: 0,
            6: 0,
            7: 0,
            8: 0,
            10: 0,
          },
          currentTeamIndex: 0,
          teamOrder: ["A", "B", "C"],
          finishedTeams: [],
          currentQuestion: null,
          currentDifficulty: null,
          pendingForkChoice: null,
          usedQuestions: { easy: [], medium: [], hard: [] },
          timerInterval: null,
          timeLeft: 0,
          timeExpired: false,
        };
        document.getElementById("winnerScreen").classList.remove("active");
        document
          .getElementById("winnerCelebrationModal")
          .classList.remove("active");
        document.getElementById("setupScreen").style.display = "block";
        document.getElementById("gameBoard").classList.remove("active");
      }

      function getCurrentTeam() {
        return gameState.teamOrder[gameState.currentTeamIndex];
      }

      function getCurrentSubTeam() {
        const team = getCurrentTeam();
        const teamData = gameState.teams[team];
        return teamData.subTeams[teamData.currentSubTeam];
      }

      function getTeamPosition(team) {
        return gameState.teams[team].position;
      }

      function getNextCheckpoint(team) {
        const pos = getTeamPosition(team);
        const branch = gameState.teams[team].branch;

        // Calculate total positions based on branches chosen
        let totalPos = 0;
        let currentPath = [];

        // Main path: positions 0-3 (START, CP1, CP2, FORK1)
        if (pos <= 3) {
          return { pos: pos, section: "main" };
        }

        // After FORK1
        if (pos <= 6) {
          const branchPos = pos - 4;
          if (gameState.teams[team].branch === "fast") {
            // Fast branch: 1 checkpoint
            if (branchPos === 0) return { pos: pos, section: "fast1" };
            return { pos: pos, section: "afterFork1" };
          } else {
            // Slow branch: 2 checkpoints
            if (branchPos <= 1) return { pos: pos, section: "slow1" };
            return { pos: pos, section: "afterFork1" };
          }
        }

        // After FORK2
        if (pos <= 9) {
          const branchPos = pos - 7;
          if (gameState.teams[team].branch2 === "fast") {
            if (branchPos === 0) return { pos: pos, section: "fast2" };
            return { pos: pos, section: "final" };
          } else {
            if (branchPos <= 1) return { pos: pos, section: "slow2" };
            return { pos: pos, section: "final" };
          }
        }

        return { pos: pos, section: "final" };
      }

      function getDifficultyForPosition(team) {
        const pos = getTeamPosition(team);
        const teamData = gameState.teams[team];

        // Positions 1-2: Easy (checkpoints ① ②)
        if (pos <= 2) return "easy";

        // Position 3: Fork decision (medium question)
        if (pos === 3) return "medium";

        // After first fork
        if (pos >= 4 && pos <= 5) {
          if (teamData.branch === "fast") return "hard";
          return "easy";
        }

        // Position 6: Second fork decision
        if (pos === 6) return "medium";

        // After second fork
        if (pos >= 7 && pos <= 8) {
          if (teamData.branch2 === "fast") return "hard";
          return "medium";
        }

        // Final checkpoint
        return "hard";
      }

      function isAtFork(team) {
        const pos = getTeamPosition(team);
        return pos === 3 || pos === 6;
      }

      function getMaxPosition(team) {
        const teamData = gameState.teams[team];
        let max = 10; // Base: START + 5 checkpoints + FINISH

        // Adjust for branch choices
        if (teamData.branch === "slow") max += 1;
        if (teamData.branch2 === "slow") max += 1;

        return max;
      }

      function renderTracks() {
        const container = document.getElementById("tracksContainer");
        container.innerHTML = "";

        ["A", "B", "C"].forEach((team) => {
          const track = document.createElement("div");
          track.className = "track";
          track.id = `track-${team}`;

          const teamData = gameState.teams[team];
          const pos = teamData.position;

          track.innerHTML = `
                    <div class="track-header">
                        <h3>🌊 Đội ${team}</h3>
                        <div class="groups">${teamData.subTeams.join(" - ")}</div>
                    </div>
                    <div class="race-path" id="path-${team}">
                        ${renderPath(team)}
                    </div>
                `;

          container.appendChild(track);
        });
      }

      function renderPath(team) {
        const teamData = gameState.teams[team];
        const pos = teamData.position;
        let html = "";

        // START
        html += `<div class="checkpoint start ${pos === 0 ? "current" : "passed"}">${pos === 0 ? "💧" : ""}START</div>`;
        html += `<div class="connector"></div>`;

        // Checkpoint 1
        html += `<div class="checkpoint normal ${pos === 1 ? "current" : pos > 1 ? "passed" : ""}">${pos === 1 ? "💧" : ""}①</div>`;
        html += `<div class="connector"></div>`;

        // Checkpoint 2
        html += `<div class="checkpoint normal ${pos === 2 ? "current" : pos > 2 ? "passed" : ""}">${pos === 2 ? "💧" : ""}②</div>`;
        html += `<div class="connector"></div>`;

        // FORK 1
        html += `<div class="checkpoint fork ${pos === 3 ? "current" : pos > 3 ? "passed" : ""}">${pos === 3 ? "💧" : ""}🔀</div>`;

        // Branch 1
        if (pos > 3 || teamData.branch) {
          html += `<div class="connector"></div>`;
          if (teamData.branch === "fast" || (!teamData.branch && pos <= 3)) {
            // Show fast branch or both if not chosen yet
            if (!teamData.branch && pos <= 3) {
              html += `<div class="fork-container">
                            <div class="fork-branch branch-fast">
                                <span class="branch-label">⚡ Nhanh</span>
                                <div class="checkpoint normal">③</div>
                            </div>
                            <div class="fork-branch branch-slow">
                                <span class="branch-label">🌿 Vòng</span>
                                <div class="checkpoint normal">③a</div>
                                <div class="connector"></div>
                                <div class="checkpoint normal">③b</div>
                            </div>
                        </div>`;
            } else {
              html += `<div class="checkpoint normal ${pos === 4 ? "current" : pos > 4 ? "passed" : ""}">${pos === 4 ? "💧" : ""}③⚡</div>`;
            }
          } else {
            html += `<div class="checkpoint normal ${pos === 4 ? "current" : pos > 4 ? "passed" : ""}">${pos === 4 ? "💧" : ""}③a</div>`;
            html += `<div class="connector"></div>`;
            html += `<div class="checkpoint normal ${pos === 5 ? "current" : pos > 5 ? "passed" : ""}">${pos === 5 ? "💧" : ""}③b</div>`;
          }
        }

        // Continue path after fork 1
        const afterFork1Pos = teamData.branch === "slow" ? 6 : 5;
        if (pos >= afterFork1Pos || teamData.branch) {
          html += `<div class="connector"></div>`;

          // FORK 2
          const fork2Pos = teamData.branch === "slow" ? 6 : 5;
          html += `<div class="checkpoint fork ${pos === fork2Pos ? "current" : pos > fork2Pos ? "passed" : ""}">${pos === fork2Pos ? "💧" : ""}🔀</div>`;

          // Branch 2
          if (pos > fork2Pos || teamData.branch2) {
            html += `<div class="connector"></div>`;
            const branch2StartPos = fork2Pos + 1;

            if (teamData.branch2 === "fast") {
              html += `<div class="checkpoint normal ${pos === branch2StartPos ? "current" : pos > branch2StartPos ? "passed" : ""}">${pos === branch2StartPos ? "💧" : ""}④⚡</div>`;
            } else if (teamData.branch2 === "slow") {
              html += `<div class="checkpoint normal ${pos === branch2StartPos ? "current" : pos > branch2StartPos ? "passed" : ""}">${pos === branch2StartPos ? "💧" : ""}④a</div>`;
              html += `<div class="connector"></div>`;
              html += `<div class="checkpoint normal ${pos === branch2StartPos + 1 ? "current" : pos > branch2StartPos + 1 ? "passed" : ""}">${pos === branch2StartPos + 1 ? "💧" : ""}④b</div>`;
            }
          }
        }

        // Final checkpoint and finish
        const finalPos = calculateFinalPos(teamData);
        if (teamData.branch2) {
          html += `<div class="connector"></div>`;
          html += `<div class="checkpoint normal ${pos === finalPos ? "current" : pos > finalPos ? "passed" : ""}">${pos === finalPos ? "💧" : ""}⑤</div>`;
          html += `<div class="connector"></div>`;
          html += `<div class="checkpoint finish ${pos > finalPos ? "current" : ""}">${pos > finalPos ? "🏆" : ""}FINISH</div>`;
        }

        return html;
      }

      function calculateFinalPos(teamData) {
        let pos = 5; // Base after fork1 fast
        if (teamData.branch === "slow") pos += 1;
        pos += 1; // Fork 2
        if (teamData.branch2 === "fast") pos += 1;
        else if (teamData.branch2 === "slow") pos += 2;
        return pos;
      }

      function renderScoreboard() {
        const grid = document.getElementById("scoreGrid");
        grid.innerHTML = "";

        Object.entries(gameState.scores).forEach(([team, score]) => {
          const item = document.createElement("div");
          item.className = "score-item";
          item.innerHTML = `
                    <div class="name">${team}</div>
                    <div class="points">${score}</div>
                `;
          grid.appendChild(item);
        });
      }

      function updateCurrentTeam() {
        const subTeam = getCurrentSubTeam();
        document.getElementById("currentTeam").textContent = subTeam;
        document.getElementById("questionTeam").textContent = subTeam;
      }

      function getRandomQuestion(difficulty) {
        const pool = questions[difficulty];
        const unused = pool.filter(
          (_, i) => !gameState.usedQuestions[difficulty].includes(i),
        );

        if (unused.length === 0) {
          // Reset if all used
          gameState.usedQuestions[difficulty] = [];
          return pool[Math.floor(Math.random() * pool.length)];
        }

        const randomIndex = Math.floor(Math.random() * unused.length);
        const originalIndex = pool.indexOf(unused[randomIndex]);
        gameState.usedQuestions[difficulty].push(originalIndex);

        return unused[randomIndex];
      }

      function showQuestion() {
        const team = getCurrentTeam();

        // Check if team already finished
        if (gameState.teams[team].finishOrder > 0) {
          nextTurn();
          return;
        }

        const difficulty = getDifficultyForPosition(team);
        const question = getRandomQuestion(difficulty);
        gameState.currentQuestion = question;
        gameState.currentDifficulty = difficulty;
        gameState.timeExpired = false; // Reset time expired flag

        const modal = document.getElementById("questionModal");
        const badge = document.getElementById("difficultyBadge");
        const content = document.getElementById("questionContent");

        // Set difficulty badge
        const difficultyLabels = { easy: "DỄ", medium: "KHÓ", hard: "RẤT KHÓ" };
        badge.textContent = difficultyLabels[difficulty];
        badge.className = `difficulty-badge difficulty-${difficulty}`;

        // Render question based on type
        content.innerHTML = renderQuestionContent(question);

        modal.classList.add("active");

        // Start timer based on difficulty
        startTimer(difficulty);
      }

      function startTimer(difficulty) {
        // Clear any existing timer
        if (gameState.timerInterval) {
          clearInterval(gameState.timerInterval);
        }

        // Set time based on difficulty: easy=7s, medium=10s, hard=15s
        const timeByDifficulty = { easy: 7, medium: 10, hard: 15 };
        gameState.timeLeft = timeByDifficulty[difficulty];

        const timerDisplay = document.getElementById("timerDisplay");

        // Reset timer display HTML (in case it was changed by timeOut)
        timerDisplay.innerHTML = `⏱️ <span id="timeLeft">${gameState.timeLeft}</span>s`;
        timerDisplay.classList.remove("warning");

        gameState.timerInterval = setInterval(() => {
          gameState.timeLeft--;
          const timeLeftSpan = document.getElementById("timeLeft");
          if (timeLeftSpan) {
            timeLeftSpan.textContent = gameState.timeLeft;
          }

          // Warning when 3 seconds or less
          if (gameState.timeLeft <= 3) {
            timerDisplay.classList.add("warning");
          }

          // Time's up!
          if (gameState.timeLeft <= 0) {
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = null;
            timeOut();
          }
        }, 1000);
      }

      function stopTimer() {
        if (gameState.timerInterval) {
          clearInterval(gameState.timerInterval);
          gameState.timerInterval = null;
        }
      }

      function timeOut() {
        // Only show timeout warning, do NOT disable buttons or mark as wrong
        // Player can still choose an answer
        const timerDisplay = document.getElementById("timerDisplay");
        timerDisplay.innerHTML =
          '<span style="color: #ef4444; font-weight: bold;">⏰ HẾT GIỜ - Hãy chọn đáp án!</span>';

        // Mark that time has expired (for UI feedback only)
        gameState.timeExpired = true;
      }

      function renderQuestionContent(question) {
        let html = `<div class="question-text">${question.question}</div>`;
        html += `<div class="answers-container">`;

        switch (question.type) {
          case "trueFalse":
            html += `
                        <button class="btn btn-answer btn-true" onclick="submitAnswer(true)">✓ ĐÚNG</button>
                        <button class="btn btn-answer btn-false" onclick="submitAnswer(false)">✗ SAI</button>
                    `;
            break;

          case "multipleChoice":
            question.options.forEach((option) => {
              const letter = option.charAt(0);
              html += `<button class="btn btn-answer" onclick="submitAnswer('${letter}')">${option}</button>`;
            });
            break;
        }

        html += `</div>`;
        html += `<div id="resultArea"></div>`;
        return html;
      }

      function submitAnswer(answer) {
        // Stop the timer immediately when answer is submitted
        stopTimer();

        const question = gameState.currentQuestion;
        let isCorrect = false;

        if (question.type === "trueFalse") {
          isCorrect = answer === question.answer;
        } else if (question.type === "multipleChoice") {
          isCorrect = answer === question.answer;
        }

        showResult(isCorrect, question.explanation);
      }

      function showResult(isCorrect, explanation) {
        // Stop the timer
        stopTimer();

        const resultArea = document.getElementById("resultArea");
        const team = getCurrentTeam();
        const subTeam = getCurrentSubTeam();
        const question = gameState.currentQuestion;

        // Format the correct answer for display
        let correctAnswerText = "";
        if (question.type === "trueFalse") {
          correctAnswerText = question.answer ? "ĐÚNG" : "SAI";
        } else if (question.type === "multipleChoice") {
          // Find the full option text for the correct answer
          const correctOption = question.options.find(
            (opt) => opt.charAt(0) === question.answer,
          );
          correctAnswerText = correctOption || question.answer;
        }

        let resultMessage = isCorrect ? "✅ CHÍNH XÁC!" : "❌ SAI RỒI!";
        let answerLine = isCorrect
          ? `<p><strong>📌 Đáp án:</strong> ${correctAnswerText}</p>`
          : `<p><strong>📌 Đáp án đúng là:</strong> ${correctAnswerText}</p>`;

        resultArea.innerHTML = `
                <div class="result-display ${isCorrect ? "result-correct" : "result-wrong"}">
                    ${resultMessage}
                </div>
                <div class="answer-reveal">
                    ${answerLine}
                    <h4>📖 Giải thích:</h4> ${explanation || "Không có giải thích."}
                </div>
                <button class="btn btn-primary" onclick="processResult(${isCorrect})" style="margin-top: 12px; padding: 10px 25px;">
                    ➡️ TIẾP TỤC
                </button>
            `;

        // Update score for correct answer
        if (isCorrect) {
          gameState.scores[subTeam] += 10;
          renderScoreboard();
        }
      }

      function processResult(isCorrect) {
        const team = getCurrentTeam();
        const teamData = gameState.teams[team];

        // Re-enable all buttons in the modal before closing
        const modal = document.getElementById("questionModal");
        const buttons = modal.querySelectorAll(".btn-answer, .btn-primary");
        buttons.forEach((btn) => (btn.disabled = false));

        document.getElementById("questionModal").classList.remove("active");

        if (isCorrect) {
          // Check if at fork
          const atFork1 = teamData.position === 3 && !teamData.branch;
          const fork2Pos = teamData.branch === "slow" ? 6 : 5;
          const atFork2 = teamData.position === fork2Pos && !teamData.branch2;

          if (atFork1 || atFork2) {
            // Show fork choice
            gameState.pendingForkChoice = atFork1 ? 1 : 2;
            document.getElementById("forkModal").classList.add("active");
            return;
          }

          // Move forward
          teamData.position++;

          // Check for finish
          checkFinish(team);
        } else {
          // Wrong at fork = forced to slow branch
          const atFork1 = teamData.position === 3 && !teamData.branch;
          const fork2Pos = teamData.branch === "slow" ? 6 : 5;
          const atFork2 = teamData.position === fork2Pos && !teamData.branch2;

          if (atFork1) {
            teamData.branch = "slow";
            teamData.position++;
          } else if (atFork2) {
            teamData.branch2 = "slow";
            teamData.position++;
          }
          // Otherwise just lose turn
        }

        renderTracks();
        nextTurn();
      }

      function chooseFork(choice) {
        const team = getCurrentTeam();
        const teamData = gameState.teams[team];

        if (gameState.pendingForkChoice === 1) {
          teamData.branch = choice;
        } else {
          teamData.branch2 = choice;
        }

        teamData.position++;
        gameState.pendingForkChoice = null;

        document.getElementById("forkModal").classList.remove("active");

        checkFinish(team);
        renderTracks();
        nextTurn();
      }

      function checkFinish(team) {
        const teamData = gameState.teams[team];
        const finishPos = calculateFinalPos(teamData) + 1;

        if (teamData.position >= finishPos && teamData.finishOrder === 0) {
          gameState.finishedTeams.push(team);
          teamData.finishOrder = gameState.finishedTeams.length;

          // Award team points
          const teamPoints = [50, 30, 20];
          const bonus = teamPoints[teamData.finishOrder - 1] || 0;

          // Add bonus to all sub-teams
          teamData.subTeams.forEach((subTeam) => {
            gameState.scores[subTeam] += bonus;
          });

          renderScoreboard();

          // First team to finish - show celebration and end game!
          if (teamData.finishOrder === 1) {
            showWinnerCelebration(team);
          }
        }
      }

      function showWinnerCelebration(team) {
        const teamData = gameState.teams[team];
        const totalScore = teamData.subTeams.reduce(
          (sum, st) => sum + gameState.scores[st],
          0,
        );

        // Update winner modal
        document.getElementById("winnerTeamName").textContent = `ĐỘI ${team}`;

        // Calculate stats
        const branchPath =
          (teamData.branch === "fast" ? "Nhanh" : "Vòng") +
          " → " +
          (teamData.branch2 === "fast" ? "Nhanh" : "Vòng");

        document.getElementById("winnerStats").innerHTML = `
          <div class="stat-card">
            <div class="label">Tổng điểm</div>
            <div class="value">${totalScore}</div>
          </div>
          <div class="stat-card">
            <div class="label">Nhóm thành viên</div>
            <div class="value">${teamData.subTeams.join(", ")}</div>
          </div>
          <div class="stat-card">
            <div class="label">Đường đi</div>
            <div class="value" style="font-size: 1em;">${branchPath}</div>
          </div>
        `;

        // Create confetti
        createConfetti();

        // Show modal
        document
          .getElementById("winnerCelebrationModal")
          .classList.add("active");
      }

      function createConfetti() {
        const colors = [
          "#f1c40f",
          "#e74c3c",
          "#27ae60",
          "#3498db",
          "#9b59b6",
          "#e67e22",
        ];
        const container = document.body;

        for (let i = 0; i < 50; i++) {
          setTimeout(() => {
            const confetti = document.createElement("div");
            confetti.className = "confetti";
            confetti.style.left = Math.random() * 100 + "vw";
            confetti.style.backgroundColor =
              colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDuration = Math.random() * 2 + 2 + "s";
            confetti.style.width = Math.random() * 10 + 5 + "px";
            confetti.style.height = Math.random() * 10 + 5 + "px";
            confetti.style.borderRadius = Math.random() > 0.5 ? "50%" : "0";
            container.appendChild(confetti);

            // Remove after animation
            setTimeout(() => confetti.remove(), 4000);
          }, i * 50);
        }
      }

      function showFinalResults() {
        document
          .getElementById("winnerCelebrationModal")
          .classList.remove("active");
        endGame();
      }

      function nextTurn() {
        const team = getCurrentTeam();
        const teamData = gameState.teams[team];

        // Move to next sub-team in current team
        teamData.currentSubTeam = (teamData.currentSubTeam + 1) % 3;

        // Move to next team
        gameState.currentTeamIndex = (gameState.currentTeamIndex + 1) % 3;

        // Skip finished teams
        let attempts = 0;
        while (
          gameState.teams[getCurrentTeam()].finishOrder > 0 &&
          attempts < 3
        ) {
          gameState.currentTeamIndex = (gameState.currentTeamIndex + 1) % 3;
          attempts++;
        }

        if (attempts >= 3) {
          endGame();
          return;
        }

        updateCurrentTeam();
      }

      function endGame() {
        gameState.finished = true;
        document.getElementById("gameBoard").classList.remove("active");

        const winnerScreen = document.getElementById("winnerScreen");
        const finalScores = document.getElementById("finalScores");

        // Sort teams by finish order (winner first, then by score)
        const sortedTeams = ["A", "B", "C"].sort((a, b) => {
          const orderA = gameState.teams[a].finishOrder || 999;
          const orderB = gameState.teams[b].finishOrder || 999;
          if (orderA !== orderB) return orderA - orderB;

          // If neither finished, sort by score
          const scoreA = gameState.teams[a].subTeams.reduce(
            (sum, st) => sum + gameState.scores[st],
            0,
          );
          const scoreB = gameState.teams[b].subTeams.reduce(
            (sum, st) => sum + gameState.scores[st],
            0,
          );
          return scoreB - scoreA;
        });

        const positions = ["first", "second", "third"];
        const trophies = ["🥇", "🥈", "🥉"];
        const labels = ["VÔ ĐỊCH", "Á Quân", "Hạng Ba"];

        finalScores.innerHTML = sortedTeams
          .map((team, index) => {
            const teamData = gameState.teams[team];
            const totalScore = teamData.subTeams.reduce(
              (sum, st) => sum + gameState.scores[st],
              0,
            );
            const finished = teamData.finishOrder > 0;

            return `
                    <div class="final-score-card ${positions[index]}">
                        <div class="trophy">${trophies[index]}</div>
                        <h3>ĐỘI ${team}</h3>
                        <div class="finish-status ${finished ? "finished" : "not-finished"}">
                          ${finished ? "✓ Về đích" : "✗ Chưa về đích"}
                        </div>
                        <div class="total-score">${totalScore} điểm</div>
                        <div class="sub-scores">
                            ${teamData.subTeams.map((st) => `<span>Nhóm ${st}: <strong>${gameState.scores[st]}</strong></span>`).join(" &nbsp;|&nbsp; ")}
                        </div>
                    </div>
                `;
          })
          .join("");

        winnerScreen.classList.add("active");
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        renderScoreboard();
      });
    </script>
  </body>
</html>
